# 领域事件 1——领域事件的建模

## 1. 领域事件的概念

领域事件是发生在聚合中的一些事情，代表聚合内已经发生的业务操作或状态变化。例如，在电子商务领域中，订单创建、支付完成等操作都可以被视为领域事件。领域事件的发生通常会影响领域模型中的一些对象状态，并且可能会触发一些业务逻辑。

领域事件通常由聚合根或其他领域对象产生，可以被其他对象订阅和处理。

领域事件是领域模型的组成部分，可以帮助我们深入理解领域模型。

关于领域事件需要注意几点：

- 应该根据限界上下文中的通用语言来命名事件

如果事件由聚合上的命令操作产生，通常根据该操作方法的名字来命名事件，并且通常采用过去式。

例如：`账户已激活`这个事件可以使用`AccountActivated`进行命名。

- 应该将事件建模成值对象的形式

应该将事件建模成值对象的形式，并根据实际情况进行妥协以适应序列化和反序列化框架需求。

> 所谓的妥协，主要是指：值对象一般建模为不可变对象，所以不提供 set 方法，领域事件由于需要序列化和反序列化，所以需要提供空的构造方法以及
> set 方法，避免框架运行错误。

## 2. 领域事件的应用

在 DDD 中，领域事件有着多种用途。

- 保证聚合间的数据一致性

当一个聚合根发生了状态变化，可以通过领域事件的方式，通知其他聚合根进行相应的更新，以保证数据一致性。

- 使用领域事件避免批量处理

逐个地处理业务事件，而不必等待所有事件都发生后再处理。

- 实现事件源模式（Event Sourcing）

使用只追加存储来记录对数据采取的完整系列操作，而不是仅存储域中数据的当前状态，通过记录系统中的所有状态变化以便跟踪问题。

- 进行限界上下文集成

实现跨域模块的通信与协作。

## 3. 领域事件的消息内容

领域事件可能只包含业务主键、事件发生时间、事件类型，这种情况下，消费者可能需要调相应的接口查询出完整的业务信息以执行业务操作。

举个例子：

```json
{
  "eventType": "MobileChanged",
  "rootId": "123456",
  "eventTime": "1681812559707",
  "eventId": "1234555"
}
```

`rootId`即聚合根 ID，是执行业务操作的业务主键，订阅者可以通过 rootId 进行获得发生该领域事件的聚合根的信息；`eventId`是领域事件的 ID，订阅者可以根据其来实现幂等；`eventType`用来区分领域事件的类型;`eventTime`是发生该领域事件的事件。

> 事件订阅者消费到消息之后，需要拿着 rootId 去查对应的服务，获取修改后的手机号的值。

领域事件也可以使用`事件增强`的方式，在领域事件中包含消费者需要的完整信息，避免消费者进行额外的查询。

```json
{
  "eventType": "MobileChanged",
  "rootId": "123456",
  "eventTime": "1681812559707",
  "afterMobile": "168168168",
  "eventId": "1234555"
}
```

`afterMobile`是发生该`MobileChanged`事件后，用户手机号的值。

> 上面这个消息中采取了事件增强的方式，消息中直接提供了修改后的手机号（afterMobile 字段），不需要再去调用接口查询。

## 4. 领域事件的建模

上文有提到领域事件应该建模为值对象，因此我们可以建模一个抽象的领域事件基类。

示例代码如下。

```java

@Data
public abstract class DomainEvent{

    private String eventId;

    private String eventType;

    private String rootId;

    private Long eventTime;
}

```

<!--@include: ../footer.md-->
